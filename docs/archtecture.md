## 概要
本ワールドは単一インスタンス内で完結し、外部連携なしでUdonSharp＋SDK3 Worldsを採用するアーキテクチャを前提とする。 核となる体験は、回答済み範囲からの暫定ベクトルに基づく即時のマッチングと上位リスト表示、ならびに即時1on1導線である。[2][1]

## 目的と原則
- 目的は「初回のみの診断＋自動要約・自動推薦」による即時対話到達であり、回答途中からでも暫定結果を提示して会話導線を確保する。[2]
- 原則は「在室者間のみ」「自己データのPlayerData永続化」「公開は縮約データのみ」「自由記述なし」という負担最小・露出最小の方針である。[1][2]

## システム境界
- 境界内: アンケート、ベクトル算出、縮約、公開同期、類似度計算、上位リストUI、1on1個室、フィードバック、エラーハンドリングを単一ワールド内で完結させる。[1][2]
- 境界外: 外部API/DB、確実通知、長期予約、画像の永続保存、他者PlayerData書込は採用しない。[2]

## 技術スタック
- Unity 2022 LTS＋VCC、VRChat SDK3 Worlds、UdonSharpを採用する。[1][2]
- PersistenceのPlayerDataを用いてユーザ自身のデータ（キー・値）をサーバ側に保存し、ワールド間でも復元可能とする前提を置く。[3][2]

## 実行時構成（ランタイム）
- Udonコンポーネントは以下で構成し、イベント駆動で連携する（回答確定・入退室・公開ON/OFF）。[1]
  - PlayerDataManager／DiagnosisController／VectorBuilder／PublicProfilePublisher／CompatibilityCalculator／RecommenderUI／SessionRoomManager／ValuesSummaryGenerator／PerfGuard／SafetyController。[1]

## コアデータ流（暫定マッチング）
- 回答確定ごとにdiag_q_001..112を逐次保存し、未回答は0で再開位置を特定する（FR-1）。[2][1]
- VectorBuilderが112→30軸を線形結合し（W）、-1..+1にクリップ・正規化してvv_0..29を算出し、完了時に確定保存する（FR-2）。[2][1]
- 公開ON時に30→6軸へ縮約（固定投影P）し、tags/headlineとともに同期変数で配布（公開OFFで即クリア）する（FR-3）。[2][1]
- CompatibilityCalculatorが在室・公開者の6軸間でコサイン類似度を分散計算し、上位3件をRecommenderUIに返す（FR-4）。[1][2]

## 同期モデル
- 公開用縮約データはUdon同期変数で配布し、Owner権限とRequestSerializationの流れを踏まえた同期設計とする（Late-joiner対応）。[4][1]
- 同期変数は型・容量制約やネットワーク負荷に留意して最低限に抑え、過剰な同期を避ける運用指針とする。[5][1]

## 推薦とリスト表示
- 類似度はcos(a,b)=dot(a,b)/(||a||·||b||+ε)で計算し、上位3名（カード）を提示するのを既定とする（拡張でN可変）。[1]  
- カードは相性％（丸表示）・価値観タグ・在室バッジ・招待ボタンを持ち、詳細で要約とレーダーを提供する（自由記述なし）。[1]

## 1on1セッション設計
- 双方同意で個室割当→テレポート→15分タイマー→終了→帰還をSessionRoomManagerが状態管理する。[1]
- 終了後にフィードバックをワンタップ記録し、短期の再推薦抑制に自分側PlayerDataを用いる（非公開・ローカル運用）。[2][1]

## データアーキテクチャ
- PlayerData（自分のみ）: diag_q_001..112:int（0–5/0=未回答）、vv_0..29:float（-1..+1）、flags:int、act_last_active:intを保存する。[2][1]
- 公開同期データ（在室・同意時）: red_0..5:float、tags:string、headline:string、display_name:stringのみを配布する（生データは公開しない）。[1]

## UI/UX要点
- ロビーは「開始／続きから／公開ON-OFF／おすすめを見る／個室へ直行」の5ボタンで最小構成に集約する。[1]
- 詳細UIはValues（要約）・Chemistry（レーダー）中心で、アバターはシルエット標準により軽量化する。[1]

## 性能とスケーリング
- 計算対象は在室公開者のみ・6軸縮約で低コスト化し、1フレームあたり演算数上限Kと増分再計算でFPS目標を維持する。[1]
- 目標はPC≥72FPS/Quest≥60FPS、全再計算PC≤5秒・Quest≤10秒、ワールドサイズPC<200MB/Quest<100MBである。[2][1]

## セキュリティとプライバシー
- 生の回答・30軸は非公開で、在室同意時の縮約・要約のみ公開するポリシーとする。[2]
- 公開OFF時は露出ゼロを保証し、入退室や公開切替の瞬間にも同期データを即時クリアする設計とする。[2][1]

## エラーとフォールバック
- PlayerData読込失敗時は再試行→リセットUIを提示し、再開点は未回答の最初へ誘導する。[1]
- データ未整合で公開ONの場合は自動OFFし、アンケート再開導線を提示して保護動作を優先する。[1]

## デプロイと運用
- VCC推奨構成・SDK3で開発し、Friends+で結合・負荷・回帰を経てPublicへ移行する運用とする。[1]
- 設問・重み・要約テンプレはScriptableObjectで外部化し、ビルドレスの調整を可能にする（Persistenceはキー管理に留意）。[6][3][1]

## 主要コンポーネント責務
- PlayerDataManager: キー管理・逐次保存・再開復元・リセットUIを担う（Persistenceのイベントを起点に実装）。[7][1]
- VectorBuilder: W行列による線形結合・正規化・vv保存、および公開用縮約Pの入力を提供する。[1]
- PublicProfilePublisher: 公開ON/OFFを監視し、red_0..5・tags・headline・display_nameを同期配布／即時クリアする。[1]
- CompatibilityCalculator: 在室公開者の縮約から類似度を分散計算し、上位3件をリストへ供給する（増分再計算）。[1]
- RecommenderUI: 上位カードと詳細UI、招待ボタンで即時1on1導線を提供する。[1]

## ランタイムフロー
- 回答中: 回答確定→逐次保存→30軸更新→6軸縮約→（公開ONなら）同期→上位リスト更新、をイベント駆動で循環させる。[2][1]
- 招待〜個室: 上位カードから招待→双方同意→個室割当→テレポ→タイマー→帰還→フィードバック、の最短導線を維持する。[1]

## リスクと緩和
- 同期過多リスク: 同期変数は最小限に留め、Owner制御とRequestSerializationの呼び出し点を限定する。[4][5][1]
- 保存キー肥大化: PlayerDataキーを計画管理し、互換破綻時は新キー保存と移行UIを提供する。[2][1]

## 受入基準との整合
- 中断・再開・完了・再訪の再現性、手入力なしの自動推薦と1on1遷移、公開OFF時の露出ゼロを満たす。[2][1]
- Questを含む性能・サイズ要件を満たし、在室公開者限定・6軸縮約・増分再計算でFPSを維持する。[2][1]

## 付記（開発メモ）
- テストはローカル・複窓で同期/負荷を検証し、入退室・公開切替・回答確定イベントをトリガーにPerfGuardのK値を調整する。[1]
- Persistence/PlayerDataの確認はSDKのClientSimやエディタ補助ツールも併用する。[6]
