## 1. 全体アーキテクチャ
- 単一ワールド内完結、外部連携なし、UdonSharp＋SDK3 Worldsを採用する。[1][2]
- 自己データはPlayerDataで永続化し、公開は在室同意者の縮約データ（同期変数）に限定する。[2][1]
- 推薦は在室者間のみとし、暫定マッチングを含む即時1on1導線に特化し、非同期予約・メッセージは実装しない。[1][2]

## 2. コンポーネント（UdonSharp）
- PlayerDataManager：キー管理、逐次保存、再開位置の復元、リセットUIを実装する。[2][1]
- DiagnosisController：112問UI、選択時に即保存し、次回入室で最後の問いへ復帰させる。[1][2]
- VectorBuilder：各回答確定で暫定vv_0..29を更新し、完了時に正規化して確定保存する（-1..+1）。[2][1]
- PublicProfilePublisher：公開ON時に30→6軸へ縮約し、tags/headlineと共に同期配布する（partial_flagとprogressを含め、OFFで即クリア）。[1][2]
- CompatibilityCalculator：在室・公開者の6軸縮約でコサイン類似度を分散計算し、自分向け上位3件を返す（進捗イベントで再計算をキュー化）。[2][1]
- RecommenderUI：上位3件のカード表示と詳細UI呼び出し、招待ボタンを提供し、暫定バッジと進捗表示を行う。[1][2]
- SessionRoomManager：双方同意→個室割当→テレポ→15分タイマー→終了→帰還のステートを管理する。[2][1]
- ValuesSummaryGenerator：30軸から要約文章とタグをテンプレ合成し、手入力なしで価値観を表示する。[1][2]
- PerfGuard：計算ジョブのキュー化・1フレーム上限・入退室/回答確定の増分再計算でフレーム負荷を抑制する。[2][1]
- SafetyController：公開スイッチ、ミュート/ブロック、注意表示などの安全UIを提供する。[1][2]

## 3. データ設計
### 3.1 PlayerData（自分のみ）
- diag_q_001..diag_q_112:int（0–5）を逐次保存し、未回答は0で再開位置を特定する。[2][1]
- vv_0..vv_29:float（-1..+1）を暫定更新し、完了時に確定保存して以降の表示・演算のベースにする。[1][2]
- flags:int（bit：公開ON=1、暫定公開可=2等）、act_last_active:intを保持する。[2][1]

### 3.2 公開同期データ（在室・同意時）
- red_0..5:float（固定投影Pで30→6軸縮約）とtags:string（上位軸から生成）を配布する。[1][2]
- headline:string（自動要約の先頭短文）とdisplay_name:stringを含める（自由記述は持たない）。[2][1]
- partial_flag:boolとprogress:intまたはprogress_pct:floatを含め、暫定ランキングの説明性を担保する。[1][2]

## 4. アンケートと算出
- 中断再開：各回答確定時点で即保存し、再入室時に最初の未回答設問へジャンプするUIを実装する。[2][1]
- 112→30軸：重み行列W（SO/Inspector編集）で線形結合し、クリップ・正規化（-1..+1）を行う（暫定は0埋めで逐次更新）。[1][2]
- 30→6軸：公開用縮約は固定投影P（SO化）で実行し、個人特定性を下げつつ意味を保つ。[2][1]
- 要約：上位正負軸に紐づく定型句を組み合わせ、短い価値観文章と#タグ群を生成する（手入力不要）。[1][2]

## 5. 推薦・相性
- 類似度：$$ \mathrm{cos}(a,b)=\frac{\langle a,b\rangle}{\|a\|\cdot\|b\|+\varepsilon} $$ で6軸縮約同士のコサイン類似度を計算する（暫定段階ではノルムが小さいため自然に抑制がかかる）。[1][2]
- 抑制：直近1on1相手は短期ペナルティで再出現を抑え、同一相手の連続セッション依存を軽減する（自分側記録のみ）。[2][1]
- 提示：自分向け上位3名をカードで示し、詳細で要約・レーダーを表示して招待に繋げる（イベント駆動で再計算・再描画）。[1][2]

## 6. UI/UX
- ロビー：開始/続きから（アンケート再開）/公開ON-OFF/おすすめを見る/個室へ直行の5ボタン構成に集約する。[2][1]
- 推薦カード：丸型相性％・価値観タグ3つ・在室バッジ・招待ボタンのみで、自由記述を排し、暫定バッジと進捗％を表示する。[1][2]
- 詳細UI：Values（要約）とChemistry（レーダー）の2タブ中心とし、Avatarはシルエット標準で軽量化する。[2][1]
- 1on1個室：15分カウント、残1分と終了ベル、退出導線、フィードバック2択の最小UIで構成する。[1][2]

## 7. フロー
1) 初回入室→アンケート開始→途中でも退出可（自動保存）→再入室で続きから再開し、回答途中でも「おすすめを見る」で上位リストを提示する。[2][1]
2) アンケート完了→自動ベクトル確定→公開ON→推薦閲覧→即時招待→1on1→フィードバックで終了する。[1][2]
3) 公開OFFのままでも自己再開や見学は可能だが、推薦には登場しない（露出ゼロ）ことを明示する。[2][1]

## 8. 性能・最適化
- 計算は在室公開者のみ・6軸縮約で低コスト化し、1フレームあたり演算数上限Kとイベント駆動の増分再計算でFPS目標を維持する。[1][2]
- ワールドサイズは焼き込みライト・共有マテリアル・テクスチャ上限（PC2048/Quest1024）・ミップで達成する。[2][1]
- ローカルテスト/複窓で同期・負荷を検証し、入退室・公開ON/OFF・回答確定ごとの増分とK調整で安定運用する。[1][2]

## 9. エラー/フォールバック
- PlayerData読込失敗→再試行→リセットUI提示（再開点は未回答最初へ）を実装し、暫定マッチングの復旧も確認する。[2][1]
- データ未整合で公開ONの場合→自動OFFしてアンケート再開導線を提示し、公開同期データを即時クリアする。[1][2]
- 個室満室→短時間待機ダイアログを提示し、在室前提のため長期予約は行わない。[2][1]

## 10. 開発/運用
- VCC推奨構成・SDK3で開発し、Friends+で結合・負荷・回帰を経てPublicへ移行する。[1][2]
- 設問・重み・縮約投影・要約テンプレはSOで管理し、リビルド無しの調整運用を行う。[2][1]
- 変更はリリースノートで通知し、データ互換が破綻する場合は新キー保存と移行UIを提供する。[1][2]
